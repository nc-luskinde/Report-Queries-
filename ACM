SELECT DISTINCT
p.plan_name 
, p.external_id
--,  smp.model_portfolio_set_uid smp_set_id
, models.value smp_set_id 
,smp.uid smp_id
, ac.asset_type
, al.weight
from  userdb_master.staged_model_portfolios smp 
inner join 
  userdb_master.allocations al 
  on al.staged_model_portfolio_id = smp.id 
  and al.db_name = smp.db_name 
left join userdb_master.asset_classes ac 
  on ac.uid = al.target_uid
  -- left join 
  -- userdb_master.model_portfolio_labels l
  -- on l.labelable_uid = smp.model_portfolio_set_uid
left join userdb_master.model_portfolio_set_activations sa
on sa.model_portfolio_set_uid = smp.model_portfolio_set_uid 
inner join 
  userdb_master.plans p 
  on p.id = sa.plan_id
  and p.db_name = sa.db_name
left join userdb_master.model_portfolio_labels models
  on models.labelable_uid = smp.model_portfolio_set_uid
  and upper(models.labelable_type) = 'MODELPORTFOLIOSET'
  and upper(models.key) = 'EXTERNAL_ID'

--where upper(l.labelable_type) = 'MODELPORTFOLIOSET'
--and upper(l.key) = 'EXTERNAL_ID'
and upper(al.target_type) = 'ASSETCLASS'
and upper(sa.status) = 'ACTIVE'
and upper(sa.type) = 'ASSETCLASSMODELPORTFOLIOSETACTIVATION'

order by 1,3,4 desc
;
-----
SELECT DISTINCT
p.plan_name 
, p.external_id
,  smp.model_portfolio_set_uid smp_set_id
,smp.uid smp_id
, ac.asset_type
, al.weight
from  userdb_master.staged_model_portfolios smp 
inner join 
  userdb_master.allocations al 
  on al.staged_model_portfolio_id = smp.id 
  and al.db_name = smp.db_name 
left join userdb_master.asset_classes ac 
  on ac.uid = al.target_uid
left join 
  userdb_master.model_portfolio_labels l
  on l.labelable_uid = smp.model_portfolio_set_uid
left join userdb_master.model_portfolio_set_activations sa
on sa.model_portfolio_set_uid = smp.model_portfolio_set_uid 
inner join 
  userdb_master.plans p 
  on p.id = sa.plan_id
  and p.db_name = sa.db_name

where upper(l.labelable_type) = 'MODELPORTFOLIOSET'
and upper(l.key) = 'EXTERNAL_ID'
and upper(al.target_type) = 'ASSETCLASS'
and upper(sa.status) = 'ACTIVE'
and upper(sa.type) = 'ASSETCLASSMODELPORTFOLIOSETACTIVATION'

order by 1,3,4 desc
;

